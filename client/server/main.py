from flask import Flask, send_from_directory, request, jsonify
from flask_cors import CORS, cross_origin
import torch
import torch.nn as nn
import torch.optim as optim
import numpy as np

app = Flask(
    __name__, static_folder="../recog-doodles-client/build", static_url_path="/"
)
cors = CORS(app)

test_image = [
    [
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7255,
            0.7608,
            0.8000,
            0.7333,
            0.7098,
            0.8824,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8745,
            0.7569,
            1.0000,
            1.0000,
            1.0000,
            0.9098,
            0.6118,
            0.7804,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7882,
            0.8667,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9882,
            0.6784,
            0.7098,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9765,
            0.9529,
            0.9804,
            1.0000,
            1.0000,
            0.9647,
            0.6980,
            0.9843,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6471,
            0.8235,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9961,
            0.7216,
            0.7412,
            0.7922,
            0.7647,
            0.7608,
            0.7882,
            0.8471,
            0.7216,
            0.5686,
            0.9373,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9647,
            0.5961,
            0.9608,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9059,
            0.7255,
            1.0000,
            1.0000,
            1.0000,
            0.9882,
            0.9647,
            0.8431,
            0.7647,
            0.5490,
            0.6078,
            0.8824,
            0.9412,
            0.9922,
            1.0000,
            1.0000,
            0.7451,
            0.8863,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7961,
            0.8392,
            1.0000,
            1.0000,
            1.0000,
            0.9882,
            0.6471,
            0.5843,
            0.6392,
            0.7059,
            0.8941,
            0.8431,
            0.7843,
            0.6667,
            0.7686,
            0.9922,
            0.8000,
            0.7725,
            0.7804,
            0.7725,
            0.7922,
            0.9020,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9255,
            0.7294,
            1.0000,
            1.0000,
            1.0000,
            0.8745,
            0.5137,
            0.9451,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9804,
            0.7529,
            0.6275,
            0.8706,
            0.8627,
            0.9569,
            0.9725,
            0.9255,
            0.7255,
            0.7412,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6941,
            0.9765,
            1.0000,
            1.0000,
            0.7412,
            0.8627,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8941,
            0.7216,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9882,
            0.5686,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8196,
            0.6902,
            0.8667,
            0.7725,
            0.5098,
            0.8431,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7333,
            0.9059,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7686,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8902,
            0.6588,
            0.5451,
            0.8784,
            0.6235,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8667,
            0.7686,
            0.9804,
            0.9529,
            1.0000,
            1.0000,
            0.7176,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9059,
            0.5961,
            0.9765,
            1.0000,
            0.7137,
            0.7020,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8431,
            0.8039,
            0.7412,
            0.6196,
            0.8627,
            1.0000,
            0.6039,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9961,
            0.6745,
            0.9176,
            1.0000,
            1.0000,
            1.0000,
            0.7098,
            0.6627,
            0.9804,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9451,
            0.5961,
            0.8863,
            0.6667,
            0.9294,
            0.7255,
            0.7020,
            0.7294,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9608,
            0.7020,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7843,
            0.7059,
            0.8314,
            0.9608,
            1.0000,
            0.9294,
            0.8235,
            0.6196,
            0.8588,
            1.0000,
            0.7569,
            0.6941,
            0.4863,
            0.6941,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9804,
            0.6902,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9843,
            0.8588,
            0.7176,
            0.5843,
            0.7922,
            0.8745,
            0.9765,
            1.0000,
            1.0000,
            1.0000,
            0.8471,
            0.6941,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6431,
            0.8980,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8941,
            0.4392,
            0.9765,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8118,
            0.8314,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8941,
            0.6157,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9294,
            0.4078,
            0.9255,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6902,
            0.9647,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7020,
            0.7804,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9922,
            0.4235,
            0.7098,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.7020,
            0.7765,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9725,
            0.6118,
            0.8118,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9490,
            0.6431,
            0.5843,
            0.6941,
            0.6980,
            0.9255,
            0.8902,
            0.6353,
            0.7451,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9804,
            0.7529,
            0.7529,
            0.8314,
            0.8627,
            0.7843,
            0.6196,
            0.8275,
            0.6941,
            1.0000,
            0.8549,
            0.8118,
            0.8157,
            0.9059,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9765,
            0.8784,
            0.8902,
            0.9098,
            0.9882,
            0.9961,
            0.6902,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6824,
            0.9922,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6784,
            0.9922,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.6784,
            0.9922,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9961,
            0.6784,
            0.9922,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9686,
            0.6863,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.9294,
            0.7176,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
        [
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            0.8784,
            0.7608,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
            1.0000,
        ],
    ]
]

class_names = [
    "airplane",
    "apple",
    "arm",
    "banana",
    "baseball bat",
    "basket",
    "basketball",
    "bat",
    "beach",
    "bear",
    "bed",
    "bee",
    "bicycle",
    "bird",
    "book",
    "bottlecap",
    "brain",
    "bread",
    "bridge",
    "bucket",
    "bus",
    "bush",
    "cake",
    "camera",
    "candle",
    "car",
    "carrot",
    "cat",
    "chair",
    "clock",
    "cloud",
    "coffee cup",
    "compass",
    "cookie",
    "cup",
    "dog",
    "donut",
    "door",
    "duck",
    "ear",
    "elephant",
    "eye",
    "face",
    "fan",
    "flower",
    "foot",
    "fork",
    "frog",
    "garden hose",
    "guitar",
    "hamburger",
    "hammer",
    "hand",
    "hat",
    "headphones",
    "ice cream",
    "key",
    "knee",
    "laptop",
    "leaf",
    "light bulb",
    "lion",
    "lollipop",
    "mailbox",
    "map",
    "pencil",
    "penguin",
    "pig",
    "pillow",
    "pizza",
    "police car",
    "pool",
    "potato",
    "rabbit",
    "rain",
    "rainbow",
    "rake",
    "snowflake",
    "soccer ball",
    "spoon",
    "square",
    "star",
    "stop sign",
    "strawberry",
    "sun",
    "swan",
    "table",
    "teddy-bear",
    "telephone",
    "tent",
    "tree",
    "truck",
    "umbrella",
    "van",
    "vase",
    "washing machine",
    "watermelon",
    "whale",
]


class DoodleDetectionModel(nn.Module):
    """This model can predict on the google doodles dataset."""

    def __init__(self, input_shape: int, hidden_units: int, output_shape: int):
        super().__init__()
        self.conv_block_1 = nn.Sequential(
            nn.BatchNorm2d(input_shape),
            nn.Conv2d(
                in_channels=input_shape,
                out_channels=6,
                kernel_size=3,
                stride=1,
                padding=1,
            ),
            nn.ReLU(),
            nn.Conv2d(
                in_channels=6, out_channels=8, kernel_size=3, stride=1, padding=1
            ),
            nn.ReLU(),
            nn.Conv2d(
                in_channels=8, out_channels=10, kernel_size=3, stride=1, padding=1
            ),
            nn.ReLU(),
            nn.BatchNorm2d(hidden_units),
            nn.MaxPool2d(kernel_size=2),
        )
        self.classifier = nn.Sequential(
            nn.Flatten(),
            nn.Linear(in_features=1960, out_features=700),
            nn.BatchNorm1d(700),
            nn.Dropout(p=0.2),
            nn.Linear(in_features=700, out_features=500),
            nn.BatchNorm1d(500),
            nn.Dropout(p=0.2),
            nn.Linear(in_features=500, out_features=400),
            nn.Dropout(p=0.2),
            nn.Linear(in_features=400, out_features=output_shape),
        )

    def forward(self, x):
        return self.classifier(self.conv_block_1(x))


model = DoodleDetectionModel(
    input_shape=1, hidden_units=10, output_shape=len(class_names)
)
model.load_state_dict(torch.load("model.pth", map_location=torch.device("cpu")))
model.eval()


@app.route("/")
@cross_origin()
def home():
    return send_from_directory(app.static_folder, "index.html")


@app.route("/predict", methods=["POST"])
@cross_origin()
def predict():
    try:
        # Get input data from the request
        data = request.get_json()  # assuming input is JSON
        input_data = np.array(data["input"]).squeeze()
        # print(input_data)
        # input_data = np.array(test_image).squeeze()

        input_tensor = torch.from_numpy(input_data).unsqueeze(0).unsqueeze(0).float()

        print(input_tensor)

        # Perform inference
        with torch.no_grad():
            pred_logits = model(input_tensor)

        pred_prob = torch.softmax(pred_logits.squeeze(), dim=0)

        print(pred_prob)

        preds = pred_prob.argmax(dim=0)

        print(preds.tolist())

        # Convert the output to a list and send as response
        return jsonify({"prediction": preds.tolist()})

    except Exception as e:
        return jsonify({"error": str(e)})


if __name__ == "__main__":
    app.run()
